<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>旅行计划结果 - AI旅行规划师</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; margin: 24px; }
    h1 { margin-bottom: 12px; }
    .card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    button { padding: 8px 16px; border: none; border-radius: 6px; background: #2563eb; color: white; cursor: pointer; }
    button.secondary { background: #111827; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 1000px) { .grid { grid-template-columns: 1fr 1fr; } }
    ul { margin: 0; padding-left: 18px; }
    .section-title { font-weight: 600; margin-top: 8px; margin-bottom: 8px; }
    .inline { display: inline-block; margin-right: 8px; }
    .muted { color: #6b7280; }
    .topbar { display:flex; gap:8px; align-items:center; margin-bottom:12px; }
  </style>
</head>
<body>
  <div class="topbar">
    <h1 style="margin:0;">旅行计划结果</h1>
    <a href="/plans" class="inline"><button class="secondary">返回我的计划</button></a>
  </div>

  {% if error %}
    <div class="card" style="background:#fef2f2; border-color:#fecaca;">
      <div style="color:#b91c1c;">{{ error }}</div>
    </div>
  {% endif %}

  {% if result %}
  <div class="card">
    <div class="section-title">保存到云端</div>
    <form action="/plans/save" method="post" class="inline">
      <input type="hidden" name="data_json" value='{{ result_json_str }}' />
      <input type="hidden" name="params_json" value='{{ params_json_str }}' />
      <input type="text" name="title" placeholder="我的旅行计划" value="{{ saved_title or title or '' }}" style="padding:6px; border:1px solid #e5e7eb; border-radius:6px;" />
      <button type="submit">保存到我的计划</button>
      {% if user %}
        <span class="muted">已登录</span>
      {% else %}
        <span class="muted">保存需要登录，未登录将跳转</span>
      {% endif %}
    </form>
  </div>

  <div class="grid">
    <div class="card">
      <div class="section-title">行程概览</div>
      <div>目的地：{{ result['行程概览']['目的地'] }} | 城市：{{ result['行程概览']['城市'] }}</div>
      <div>天数：{{ result['行程概览']['天数'] }} | 总预算(¥)：{{ result['行程概览']['总预算'] or '未指定' }}</div>
      <div>人数：成人 {{ result['行程概览']['人数']['adults'] }}，儿童 {{ result['行程概览']['人数']['children'] }}</div>
      <div>主题标签：
        {% if result['行程概览']['旅行主题'] %}
          {{ ", ".join(result['行程概览']['旅行主题']) }}
        {% else %}
          <span class="muted">无</span>
        {% endif %}
      </div>
    </div>

    <div class="card">
      <div class="section-title">费用明细表</div>
      <div class="section-title">预算分配</div>
      <ul>
        {% for k, v in result['费用明细表']['预算分配'].items() %}
          <li>{{ k }}：¥{{ v }}</li>
        {% endfor %}
      </ul>
      <div class="section-title">估算费用</div>
      <ul>
        {% for k, v in result['费用明细表']['估算费用'].items() %}
          <li>{{ k }}：¥{{ v }}</li>
        {% endfor %}
      </ul>
      <div class="section-title">建议档位</div>
      <ul>
        {% for k, v in result['费用明细表']['建议档位'].items() %}
          <li>{{ k }}：¥{{ v }}</li>
        {% endfor %}
      </ul>
      {% if result['费用明细表']['实际支出']['warning'] %}
        <div class="section-title">超支预警</div>
        <ul>
          {% for w in result['费用明细表']['实际支出']['warning'] %}
            <li>{{ w }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    </div>

    <div class="card" id="schedule-section" style="grid-column: 1 / -1;">
      <div class="section-title">详细日程</div>
      {% for day in result['详细日程'] %}
        <div class="card">
          <div><strong>{{ day['日期'] }}</strong> ｜ 主题：{{ day['主题'] }}</div>
          <ul>
            {% for item in day['安排'] %}
              {% if item.get('地点') %}
                <li>{{ item['地点'] }}（{{ item.get('类型','') }}）｜ 时间：{{ item.get('开放时间','') }}｜ 门票：¥{{ item.get('门票(¥)',0) }}｜ 时长：{{ item.get('游玩时长(h)',2) }}h｜ 区域：{{ item.get('区域','') }}</li>
              {% elif item.get('餐厅') %}
                <li>餐厅：{{ item['餐厅'] }}（{{ item.get('美食类型','') }}）｜ 人均：¥{{ item.get('人均(¥)',0) }}｜ 位置：{{ item.get('位置','') }}</li>
              {% endif %}
            {% endfor %}
          </ul>
          <div class="muted">备注：{{ day['备注'] }}</div>
        </div>
      {% endfor %}
    </div>

    <div class="card">
      <div class="section-title">住宿推荐</div>
      <div>酒店：{{ result['住宿推荐']['name'] }}｜ 区域：{{ result['住宿推荐']['area'] }}</div>
      <div>价格区间(¥)：{{ result['住宿推荐']['price_range_cny'][0] }} - {{ result['住宿推荐']['price_range_cny'][1] }}</div>
    </div>

    <div class="card">
      <div class="section-title">交通建议</div>
      <div>机场进城：</div>
      <ul>
        {% for t in result['交通建议']['airport_city'] %}
          <li>{{ t['route'] }} ｜ {{ t['mode'] }} ｜ 约 ¥{{ t['cost_cny'] }} ｜ {{ t['duration_min'] }} 分钟</li>
        {% endfor %}
      </ul>
      <div>当地交通卡/票：</div>
      <ul>
        {% for t in result['交通建议']['local'] %}
          <li>{{ t.get('card') or t.get('pass') }} ｜ {{ t['benefit'] }}</li>
        {% endfor %}
      </ul>
    </div>

    <div class="card" style="grid-column: 1 / -1;">
      <div class="section-title">实用信息</div>
      <div>天气提示：{{ result['实用信息']['天气提示'] }}</div>
      <div>交通卡/优惠：</div>
      <ul>
        {% for tip in result['实用信息']['交通卡/优惠'] %}
          <li>{{ tip }}</li>
        {% endfor %}
      </ul>
      <div>注意事项：</div>
      <ul>
        {% for note in result['实用信息']['注意事项'] %}
          <li>{{ note }}</li>
        {% endfor %}
      </ul>
    </div>
  </div>
  {% endif %}

  {% if result %}
  <div class="card" style="margin-top: 16px;">
    <div class="section-title">地图可视化</div>
    {% if render_for_plan %}
      <div class="muted" style="margin-bottom:8px;">此页面暂不展示地图。</div>
      <form action="/plans/save" method="post" style="display:flex; gap:8px; align-items:center;">
        <input type="hidden" name="data_json" value='{{ result_json_str }}' />
        <input type="hidden" name="params_json" value='{{ params_json_str }}' />
        <input type="hidden" name="title" value="{{ title or '我的旅行计划' }}" />
        <button type="submit">保存并前往该计划页面观察</button>
        <span class="muted">将自动保存并跳转到该计划详情</span>
      </form>
    {% elif amap_key %}
      <div id="day-controls" style="display:flex; gap:8px; align-items:center; margin-bottom:8px;"></div>
      <div id="amap" style="width:100%; height:420px; border:1px solid #e5e7eb; border-radius:8px;"></div>
      <div class="muted" style="margin-top:6px;">出行方式：{{ '驾车' if (travel_mode or 'driving') == 'driving' else ('步行' if travel_mode == 'walking' else ('骑行' if travel_mode == 'riding' else '驾车')) }}。在地图上显示酒店与每日行程景点，并用真实路线标注每日路径。</div>
      <script type="application/json" id="result-json">{{ result_json_str|safe }}</script>
      {% if amap_js_sec_code %}
      <script>
        window._AMapSecurityConfig = { securityJsCode: '{{ amap_js_sec_code }}' };
      </script>
      {% endif %}
      <script src="https://webapi.amap.com/maps?v=2.0&key={{ amap_key }}&plugin=AMap.Geocoder,AMap.PlaceSearch,AMap.Driving,AMap.Walking,AMap.Riding"></script>
      <script>
        (function(){
          try {
        // 优先从JSON中解析每日景点名称，若失败则回退从DOM提取
        var resultData = null;
        (function(){
          var el = document.getElementById('result-json');
          if (el && el.textContent) {
            try { resultData = JSON.parse(el.textContent); } catch (e) { console.warn('解析结果JSON失败：', e); }
          }
        })();

        var cityRaw = (resultData && resultData['行程概览'] && resultData['行程概览']['城市']) || "{{ result['行程概览']['城市'] }}";
        var destRaw = (resultData && resultData['行程概览'] && resultData['行程概览']['目的地']) || "{{ result['行程概览']['目的地'] }}";
        function normalizeCity(s){
          if (!s) return '';
          var t = String(s).trim();
          // 以常见分隔符拆分：中文顿号/逗号、英文逗号、斜杠、反斜杠、空白
          t = t.split(/[、，,\/\\\s]+/)[0];
          t = t.replace(/市$/,'');
          return t;
        }
        var city = normalizeCity(cityRaw) || normalizeCity(destRaw);
        var hotelName = (resultData && resultData['住宿推荐'] && resultData['住宿推荐']['name']) || "{{ result['住宿推荐']['name'] }}";

        function collectDayStopsFromDom() {
          var container = document.getElementById('schedule-section');
          var days = [];
          if (!container) return days;
          var dayCards = container.querySelectorAll(':scope > .card');
          dayCards.forEach(function(card){
            var arr = [];
            card.querySelectorAll('ul > li').forEach(function(li){
              var t = (li.textContent || '').trim();
              if (t.startsWith('餐厅：')) return; // 跳过餐厅条目
              // 提取“地点”名称，取“（”或“｜”之前的部分
              var m = t.match(/^([^（|｜]+)[（|｜]/);
              if (m && m[1]) {
                arr.push(m[1].trim());
              } else {
                var fallback = t.split('｜')[0].split('(')[0].trim();
                if (fallback) arr.push(fallback);
              }
            });
            days.push(arr);
          });
          return days;
        }
        function collectDayStopsFromData() {
          var days = [];
          try {
            var list = resultData && (resultData['详细日程'] || resultData['plan']);
            if (Array.isArray(list)) {
              list.forEach(function(day){
                var arr = [];
                var items = day && (day['安排'] || []);
                items.forEach(function(item){
                  if (item && item['餐厅']) return; // 跳过餐饮
                  var name = item && (item['地点'] || item['name']);
                  if (name) arr.push(String(name));
                });
                days.push(arr);
              });
            }
          } catch (e) {
            console.warn('从数据解析每日景点失败：', e);
          }
          return days;
        }
        var dayStops = (resultData ? collectDayStopsFromData() : collectDayStopsFromDom());

        // 预览环境可能阻拦 nebula/v2 矢量瓦片请求，改用 2D 以降低网络报错概率
        var map = new AMap.Map('amap', { zoom: 12, center: [116.397428, 39.90923], viewMode: '2D' });
        var geocoder = new AMap.Geocoder({ city: city });
        var placeSearch = new AMap.PlaceSearch({ city: city });
        var centerSet = false;
        // 根据城市名称设置地图初始中心
        function setInitialCenter(cityName) {
          geocoder.getLocation(cityName, function(status, result){
            if (status === 'complete' && result && result.geocodes && result.geocodes.length > 0) {
              var gc = result.geocodes[0];
              var center = [parseFloat(gc.location.lng), parseFloat(gc.location.lat)];
              map.setCenter(center);
              map.setZoom(12);
              centerSet = true;
            } else {
              // 回退：用 POI 搜索定位城市中心
              placeSearch.search(cityName, function(psStatus, psResult){
                if (psStatus === 'complete' && psResult && psResult.poiList && psResult.poiList.pois && psResult.poiList.pois.length > 0) {
                  var poi = psResult.poiList.pois[0];
                  if (poi.location) {
                    var center2 = [parseFloat(poi.location.lng), parseFloat(poi.location.lat)];
                    map.setCenter(center2);
                    map.setZoom(12);
                    centerSet = true;
                  }
                }
              });
            }
          });
        }
        var router;
        var __mode = "{{ travel_mode or 'driving' }}";
        function initRouterByMode(mode){
          if (mode === 'walking') {
            router = new AMap.Walking({ map: null });
          } else if (mode === 'riding') {
            router = new AMap.Riding({ map: null });
          } else {
            router = new AMap.Driving({ map: null, policy: AMap.DrivingPolicy.LEAST_TIME, showTraffic: false });
          }
        }
        initRouterByMode(__mode);
        var palette = ['#2563eb','#16a34a','#dc2626','#7c3aed','#f59e0b','#0ea5e9'];
        // 初始化时根据城市定位中心
        setInitialCenter(city);
        var dayRoutes = [];
        var currentRoutes = [];
        var dayMarkers = [];
        var currentMarkers = [];
        var dayLinesRaw = [];
        var currentDayIndex = 0;
        var renderedOnce = false;

        function createMarker(lnglat, title, type, color) {
          return new AMap.Marker({
            position: lnglat,
            title: title,
            icon: type === 'hotel' ? 'https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png' : 'https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png'
          });
        }

        function geocode(address) {
          return new Promise(function(resolve){
            geocoder.getLocation(address, function(status, result){
              if (status === 'complete' && result && result.geocodes && result.geocodes.length > 0) {
                var gc = result.geocodes[0];
                resolve([parseFloat(gc.location.lng), parseFloat(gc.location.lat)]);
              } else {
                // 回退：使用 POI 搜索获取坐标
                placeSearch.search(address, function(psStatus, psResult){
                  if (psStatus === 'complete' && psResult && psResult.poiList && psResult.poiList.pois && psResult.poiList.pois.length > 0) {
                    var poi = psResult.poiList.pois[0];
                    if (poi.location) {
                      resolve([parseFloat(poi.location.lng), parseFloat(poi.location.lat)]);
                      return;
                    }
                  }
                  // 再回退一次：不加城市前缀直接搜名称
                  placeSearch.search(address.replace(city + ' ', ''), function(psStatus2, psResult2){
                    if (psStatus2 === 'complete' && psResult2 && psResult2.poiList && psResult2.poiList.pois && psResult2.poiList.pois.length > 0) {
                      var poi2 = psResult2.poiList.pois[0];
                      if (poi2.location) {
                        resolve([parseFloat(poi2.location.lng), parseFloat(poi2.location.lat)]);
                        return;
                      }
                    }
                    console.warn('地理编码/POI 搜索均失败：', address, status, result);
                    resolve(null);
                  });
                });
              }
            });
          });
        }

        async function routeBetween(o, d) {
          return new Promise(function(resolve){
            router.search(new AMap.LngLat(o[0], o[1]), new AMap.LngLat(d[0], d[1]), function(status, result){
              var pts = [];
              try {
                if (status === 'complete' && result) {
                  var r = (result.routes && result.routes[0]) || (result.paths && result.paths[0]) || null;
                  if (r) {
                    if (r.steps && r.steps.length) {
                      r.steps.forEach(function(step){
                        if (step.path && step.path.length) {
                          step.path.forEach(function(p){
                            pts.push([p.lng, p.lat]);
                          });
                        }
                      });
                    } else if (r.path && r.path.length) {
                      r.path.forEach(function(p){ pts.push([p.lng, p.lat]); });
                    } else if (r.rides && r.rides.length) {
                      r.rides.forEach(function(ride){
                        if (ride.path && ride.path.length) {
                          ride.path.forEach(function(p){ pts.push([p.lng, p.lat]); });
                        }
                      });
                    }
                  }
                }
              } catch (e) {
                console.warn('解析路线失败：', e);
              }
              resolve(pts || []);
            });
          });
        }

        function renderDay(dayIndex) {
          currentDayIndex = dayIndex;
          // 清除之前显示的路线
          currentRoutes.forEach(function(r){ r.setMap(null); });
          currentRoutes = [];
          // 清除之前显示的标注
          currentMarkers.forEach(function(m){ m.setMap(null); });
          currentMarkers = [];
          var routes = dayRoutes[dayIndex] || [];
          routes.forEach(function(r){ r.setMap(map); });
          currentRoutes = routes.slice();
          var markers = dayMarkers[dayIndex] || [];
          markers.forEach(function(m){ m.setMap(map); });
          currentMarkers = markers.slice();
          var overlays = currentRoutes.concat(currentMarkers);
          if (overlays.length) { map.setFitView(overlays); }
          // 更新按钮激活态
          var controls = document.getElementById('day-controls');
          if (controls) {
            controls.querySelectorAll('button[data-day]').forEach(function(btn){
              if (parseInt(btn.dataset.day) === dayIndex) {
                btn.style.background = '#2563eb'; btn.style.color = '#fff';
              } else {
                btn.style.background = '#111827'; btn.style.color = '#fff';
              }
            });
          }
        }

        function buildDayControls() {
          var controls = document.getElementById('day-controls');
          if (!controls) return;
          controls.innerHTML = '';
          var label = document.createElement('span');
          label.textContent = '选择天数：';
          label.className = 'muted';
          controls.appendChild(label);
          // 计算天数：优先用结果JSON的详细日程长度，否则用 DOM 的卡片数量，再否则用 dayStops 长度
          var jsonDays = (resultData && Array.isArray(resultData['详细日程'])) ? resultData['详细日程'].length : 0;
          var templateDays = (function(){
            var container = document.getElementById('schedule-section');
            if (!container) return 0;
            var directCards = Array.prototype.filter.call(container.children, function(node){
              return node && node.classList && node.classList.contains('card');
            });
            return directCards.length || 0;
          })();
          var nDays = Math.max(jsonDays, templateDays, dayStops.length);
          if (nDays === 0) { nDays = 1; }
          for (var i = 0; i < nDays; i++) {
            var btn = document.createElement('button');
            btn.type = 'button';
            btn.dataset.day = String(i);
            btn.textContent = '第' + (i+1) + '天';
            btn.className = 'secondary';
            btn.style.padding = '6px 10px';
            btn.style.borderRadius = '6px';
            btn.style.cursor = 'pointer';
            (function(idx){
              btn.addEventListener('click', function(){ renderDay(idx); });
            })(i);
            controls.appendChild(btn);
          }
          // 出行方式切换
          var sep = document.createElement('span');
          sep.textContent = '｜'; sep.className = 'muted'; sep.style.margin = '0 6px';
          controls.appendChild(sep);
          var modeLabel = document.createElement('span');
          modeLabel.textContent = '出行方式：'; modeLabel.className = 'muted';
          controls.appendChild(modeLabel);
          ['driving','walking','riding'].forEach(function(m){
            var btn = document.createElement('button');
            btn.type = 'button';
            btn.dataset.mode = m;
            btn.textContent = (m==='driving'?'驾车':(m==='walking'?'步行':'骑行'));
            btn.className = 'secondary';
            btn.style.padding = '6px 10px';
            btn.style.borderRadius = '6px';
            btn.style.cursor = 'pointer';
            if (__mode === m) { btn.style.background = '#2563eb'; btn.style.color = '#fff'; }
            btn.addEventListener('click', async function(){
              __mode = this.dataset.mode;
              // 更新激活态
              controls.querySelectorAll('button[data-mode]').forEach(function(b){
                if (b.dataset.mode === __mode) { b.style.background = '#2563eb'; b.style.color = '#fff'; }
                else { b.style.background = '#111827'; b.style.color = '#fff'; }
              });
              initRouterByMode(__mode);
              await rebuildRoutes();
              renderDay(currentDayIndex);
            });
            controls.appendChild(btn);
          });
        }

        (async function(){
          var hotelCoord = null;
          var hotelMarker = null;
          if (hotelName) {
            var h = await geocode(city + ' ' + hotelName);
            if (h) {
              hotelCoord = h;
              hotelMarker = createMarker(h, hotelName, 'hotel');
              if (!centerSet) { map.setCenter(h); centerSet = true; }
            }
          }
          buildDayControls();
          for (var di = 0; di < dayStops.length; di++) {
            var stops = dayStops[di];
            if (!Array.isArray(stops) || stops.length === 0) {
              // 当天无景点：仅渲染酒店（若存在），且不构建路线
              dayRoutes[di] = [];
              dayMarkers[di] = (hotelCoord && hotelMarker) ? [hotelMarker] : [];
              dayLinesRaw[di] = (hotelCoord && hotelMarker) ? [hotelCoord] : [];
              if (di === 0 && !renderedOnce) { renderDay(0); renderedOnce = true; }
              continue;
            }
            var color = palette[di % palette.length];
            var dayLine = [];
            var markersArr = [];
            // 起点：酒店
            if (hotelCoord && hotelMarker) {
              dayLine.push(hotelCoord);
              markersArr.push(hotelMarker);
            }
            for (var si = 0; si < stops.length; si++) {
              var name = stops[si];
              if (!name) continue;
              var p = await geocode(city + ' ' + name);
              if (p) {
                var mk = createMarker(p, name, 'spot', color);
                try { mk.setLabel({ content: String(si+1), direction: 'top' }); } catch(e) { /* 兼容处理 */ }
                markersArr.push(mk);
                if (!centerSet) { map.setCenter(p); centerSet = true; }
                dayLine.push(p);
              }
            }
            // 终点：酒店（仅当当天存在景点时才回到酒店）
            if (hotelCoord && stops.length > 0) {
              dayLine.push(hotelCoord);
            }
            dayRoutes[di] = dayRoutes[di] || [];
            for (var i = 0; i < dayLine.length - 1; i++) {
              var seg = await routeBetween(dayLine[i], dayLine[i+1]);
              var pathToDraw = (seg && seg.length >= 2) ? seg : [dayLine[i], dayLine[i+1]]; // 回退为直线
              var routeLine = new AMap.Polyline({
                path: pathToDraw,
                isOutline: true,
                outlineColor: '#ffffff',
                borderWeight: 2,
                strokeColor: color,
                strokeOpacity: 0.9,
                strokeWeight: 4,
              });
              dayRoutes[di].push(routeLine);
            }
            dayMarkers[di] = markersArr;
            dayLinesRaw[di] = dayLine.slice();
            if (di === 0 && !renderedOnce) { renderDay(0); renderedOnce = true; }
          }
          if (!renderedOnce) { renderDay(0); renderedOnce = true; }
        })();

        async function rebuildRoutes(){
          // 清除旧路线覆盖物
          currentRoutes.forEach(function(r){ r.setMap(null); });
          currentRoutes = [];
          dayRoutes = [];
          for (var di = 0; di < dayLinesRaw.length; di++) {
            var dayLine = dayLinesRaw[di] || [];
            dayRoutes[di] = [];
            if (!Array.isArray(dayLine) || dayLine.length < 2) {
              continue; // 跳过无有效路线的日子
            }
            for (var i = 0; i < dayLine.length - 1; i++) {
              var seg = await routeBetween(dayLine[i], dayLine[i+1]);
              var pathToDraw = (seg && seg.length >= 2) ? seg : [dayLine[i], dayLine[i+1]];
              var color = palette[di % palette.length];
              var routeLine = new AMap.Polyline({
                path: pathToDraw,
                isOutline: true,
                outlineColor: '#ffffff',
                borderWeight: 2,
                strokeColor: color,
                strokeOpacity: 0.9,
                strokeWeight: 4,
              });
              dayRoutes[di].push(routeLine);
            }
          }
        }
      } catch (e) {
        console.error('地图初始化异常：', e);
      }
    })();
      </script>
    {% else %}
      <div class="error" style="background:#fef2f2; border:1px solid #fecaca; color:#b91c1c; padding:8px; border-radius:6px;">
        未配置高德地图 API Key，无法加载地图。请在 <code>travel_planner_agent/config.py</code> 中设置 <code>AMAP_WEB_KEY</code> 或导出环境变量 <code>AMAP_WEB_KEY</code>。
      </div>
    {% endif %}
  </div>
  {% endif %}

</body>
</html>